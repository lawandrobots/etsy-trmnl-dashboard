<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etsy Dashboard - trmnl Plugin</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 20px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            border: 2px solid #fff;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .shop-name {
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-box {
            border: 1px solid #fff;
            padding: 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .sales-section {
            border: 1px solid #fff;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #fff;
            padding-bottom: 5px;
        }
        
        .sale-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #666;
        }
        
        .sale-item:last-child {
            border-bottom: none;
        }
        
        .sale-amount {
            font-weight: bold;
        }
        
        .sale-time {
            opacity: 0.7;
            font-size: 12px;
        }
        
        .alert {
            background-color: #333;
            border: 2px solid #fff;
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.7; }
        }
        
        .status {
            text-align: center;
            font-size: 12px;
            opacity: 0.6;
            margin-top: 20px;
        }
        
        .error {
            color: #ff6b6b;
            text-align: center;
            padding: 20px;
            border: 2px solid #ff6b6b;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .no-sales {
            text-align: center;
            opacity: 0.7;
            padding: 20px;
        }
        
        @media (max-width: 600px) {
            .metrics {
                grid-template-columns: 1fr;
            }
            
            body {
                font-size: 12px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="content">
            <div class="loading">
                <div>Loading Etsy Dashboard...</div>
                <div style="margin-top: 10px;">‚óè‚óè‚óè</div>
            </div>
        </div>
    </div>

    <script>
        class EtsyDashboard {
            constructor() {
                // Configuration - replace with your actual values
                this.config = {
                    // Backend API endpoint - change this to your deployed URL
                    apiEndpoint: '/api/etsy-data',
                    refreshInterval: 300000, // 5 minutes
                    shopName: 'Your Shop Name' // Fallback shop name
                };
                
                this.lastUpdate = null;
                this.currentData = null;
            }

            async init() {
                await this.fetchData();
                this.render();
                
                // Set up auto-refresh
                setInterval(() => {
                    this.fetchData().then(() => this.render());
                }, this.config.refreshInterval);
            }

            async fetchData() {
                try {
                    // Use absolute URL to ensure it works
                    const apiUrl = window.location.origin + '/api/etsy-data';
                    console.log('Fetching from:', apiUrl);
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log('Received data:', data);
                    
                    this.currentData = data;
                    this.lastUpdate = new Date();
                } catch (error) {
                    console.error('Error fetching Etsy data:', error);
                    this.renderError(`Failed to fetch data: ${error.message}`);
                }
            }

            getMockData() {
                // Mock data for demonstration
                // Replace this with actual API call to your backend
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                return {
                    shop: {
                        shop_name: "Your Etsy Shop",
                        total_sales: 1247,
                        total_favorites: 892
                    },
                    todaysSales: [
                        {
                            id: 1,
                            amount: 45.99,
                            buyer: "Customer #1234",
                            time: new Date(now - 2 * 60 * 60 * 1000), // 2 hours ago
                            items: ["Custom Mug", "Sticker Pack"]
                        },
                        {
                            id: 2,
                            amount: 23.50,
                            buyer: "Customer #5678",
                            time: new Date(now - 4 * 60 * 60 * 1000), // 4 hours ago
                            items: ["T-Shirt"]
                        },
                        {
                            id: 3,
                            amount: 78.00,
                            buyer: "Customer #9101",
                            time: new Date(now - 6 * 60 * 60 * 1000), // 6 hours ago
                            items: ["Custom Art Print", "Frame"]
                        }
                    ],
                    stats: {
                        todayRevenue: 147.49,
                        todaySalesCount: 3,
                        monthlyRevenue: 2890.45,
                        monthlySalesCount: 67
                    }
                };
            }

            render() {
                if (!this.currentData) return;

                const { shop, todaysSales, stats } = this.currentData;
                const hasNewSales = todaysSales.length > 0;

                let html = `
                    <div class="header">
                        <div>üõçÔ∏è ETSY DASHBOARD</div>
                        <div class="shop-name">${shop.shop_name}</div>
                    </div>
                `;

                if (hasNewSales) {
                    html += `
                        <div class="alert">
                            üîî ${stats.todaySalesCount} NEW SALE${stats.todaySalesCount > 1 ? 'S' : ''} TODAY!
                        </div>
                    `;
                }

                html += `
                    <div class="metrics">
                        <div class="metric-box">
                            <span class="metric-value">$${stats.todayRevenue.toFixed(2)}</span>
                            <div class="metric-label">TODAY'S REVENUE</div>
                        </div>
                        <div class="metric-box">
                            <span class="metric-value">${stats.todaySalesCount}</span>
                            <div class="metric-label">TODAY'S SALES</div>
                        </div>
                    </div>

                    <div class="metrics">
                        <div class="metric-box">
                            <span class="metric-value">$${stats.monthlyRevenue.toFixed(2)}</span>
                            <div class="metric-label">THIS MONTH</div>
                        </div>
                        <div class="metric-box">
                            <span class="metric-value">${shop.total_sales}</span>
                            <div class="metric-label">TOTAL SALES</div>
                        </div>
                    </div>

                    <div class="sales-section">
                        <div class="section-title">üìã TODAY'S SALES</div>
                `;

                if (todaysSales.length === 0) {
                    html += `<div class="no-sales">No sales yet today. Keep promoting! üöÄ</div>`;
                } else {
                    todaysSales.forEach((sale, index) => {
                        const timeStr = this.formatTime(sale.time);
                        const itemsStr = sale.items.join(', ');
                        
                        html += `
                            <div class="sale-item">
                                <div>
                                    <div class="sale-amount">$${sale.amount.toFixed(2)}</div>
                                    <div style="font-size: 11px; opacity: 0.8;">${itemsStr}</div>
                                </div>
                                <div class="sale-time">${timeStr}</div>
                            </div>
                        `;
                    });
                }

                html += `
                    </div>
                    <div class="status">
                        Last updated: ${this.formatTime(this.lastUpdate)}
                        ${hasNewSales ? ' | üéâ Great job on today\'s sales!' : ' | üí™ Keep pushing!'}
                    </div>
                `;

                document.getElementById('content').innerHTML = html;
            }

            renderError(message) {
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <div style="font-size: 18px; margin-bottom: 10px;">‚ùå Error</div>
                        <div>${message}</div>
                        <div style="margin-top: 10px; font-size: 12px;">
                            Last attempt: ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                `;
            }

            formatTime(date) {
                if (!date) return 'Unknown';
                
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                
                if (diffMins < 60) {
                    return `${diffMins}m ago`;
                } else if (diffHours < 24) {
                    return `${diffHours}h ago`;
                } else {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }
        }

        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const dashboard = new EtsyDashboard();
            dashboard.init();
        });

        // Handle visibility change to refresh when tab becomes active
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Refresh data when tab becomes visible
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        });
    </script>
</body>
</html>
